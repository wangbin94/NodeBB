(function(){var Settings,SocketAdmin,SocketModules,appGet,constants,defaultConfig,emoji,emojiPath,execMapping,fs,initAdminRoute,initSockets,mapTest,mapping,meta,nconf,path,renderAdminPage,settings;fs=require("fs"),path=require("path"),meta=module.parent.require("../src/meta"),nconf=module.parent.require("nconf"),SocketModules=module.parent.require("./socket.io/modules"),SocketAdmin=module.parent.require("./socket.io/admin"),emoji=require("emoji-images"),Settings=module.parent.require("../src/settings"),emojiPath=nconf.get("url")+"/plugins/nodebb-plugin-emoji-extended/images",defaultConfig={maxCount:8,minChars:0,killSkype:1,completePrefix:"^|[^\\w\\d)\\]}+\\-]",zoom:64},settings=new Settings("emoji-extended","0.2.4-2",defaultConfig,null,!1,!1),appGet=function(app,url,mw,cb){return app.get(url,mw,cb),app.get("/api"+url,cb)},constants=Object.freeze({name:"Emoji Extended",admin:{route:"/plugins/emoji-extended",icon:"fa-smile-o"}}),renderAdminPage=function(req,res){return res.render("admin/plugins/emoji-extended",{})},initAdminRoute=function(app,middleware){return appGet(app,"/admin"+constants.admin.route,middleware.admin.buildHeader,renderAdminPage)},module.exports.adminBuild=function(custom_header,cb){return custom_header.plugins.push({route:constants.admin.route,icon:constants.admin.icon,name:constants.name}),cb(null,custom_header)},module.exports.appLoad=function(app,middleware){return initSockets(),initAdminRoute(app,middleware)},module.exports.composerHelp=function(helpMessage,callback){var mappingEnabled;return mappingEnabled=settings.get("killSkype"),helpMessage+='<h2>Emoji Extended</h2>\n<p>\n  This forum has emoji enabled.<br>\n  Plugins begin end end with <code>:</code> like <code>:smile:</code>, <code>:wink:</code>, etc. For a full list see <a href="http://www.emoji-cheat-sheet.com">Emoji cheat sheet</a>.',mappingEnabled&&(helpMessage+="<br>\nAlso some common shortens like <code>:)</code>, <code>:P</code>, <code>;)</code>, <code>:-)</code>, etc. can be used."),mappingEnabled+="</p>",callback(null,helpMessage)},mapping=[/:[-=]?s/i,":confounded:",/:[-=]?d/i,":laughing:",/:[-=]?o/i,":hushed:",/:[-=]?[x#]/i,":no_mouth:",/:[-=]?[\*p]/i,":stuck_out_tongue_winking_eye:",/:[-=]?\)/,":grinning:",/:[-=]?\(/,":frowning:",/[8b][-=]?[\|\)]/i,":sunglasses:",/;[-=]?\)/,":wink:",/;[-=]?\(/,":relieved:",/:[-=]?\|/,":expressionless:",/:[-=]?\$|:&quot>/,":blush:",/:\^\)/,":smirk:",/[\|i][-=]?\)/,":sleeping:",/\|[-=]?\(/,":pensive:",/:[-=]?&amp;/,":mask:",/;\/\)/,":trollface:",/:[-=]?@/,":rage:",/x[-=]?\(/i,":rage:",/:[-=]?\?/,":confused:",/\?\?\?/,":question:",/&lt;3/,":heart:",/zzz/i,":zzz:",/o_o/i,":eyes:"],mapTest=/(^|\s|<\/?[\w-]+>)(:[=-]?[\(\)\|\*\$@#\?]|:[=-]?&amp;|;[=-]?[\(\)]|[8b][=-]?[\)\|]|[\|i][-=]?[\(\)]|x[-=]?[\(\)]|:&quot;>|:\^\)|;\/\)|\?{3}|z{3}|o_o)|(^|\s|<(br|p)>)(&lt;3)(<\/?\w+>|\s|$)|(:[=-]?[dopsx])(<\/?[\w-]+>|\s|$)/gi,execMapping=function(content){return content.replace(mapTest,function(match){var ignored,m,_i,_len;for(_i=0,_len=mapping.length;_len>_i;_i++)if(ignored=mapping[_i],m=match.replace(mapping[_i],mapping[++_i]),m!==match)return m;return match})},module.exports.parseEmoji=function(postContent,cb){var mappingEnabled;return mappingEnabled=settings.get("killSkype"),cb(null,postContent.replace(/(^|<\/code>)([^<]*|<(?!code>))*(<code>|$)/g,function(match){return emoji(mappingEnabled?execMapping(match):match,emojiPath,null)}))},initSockets=function(){return SocketModules.emojiExtended=function(socket,data,cb){return cb(null,settings.get())},SocketAdmin.settings.syncEmojiExtended=function(){return settings.sync()},SocketAdmin.settings.getEmojiExtendedDefaults=function(socket,data,callback){return callback(null,settings.createDefaultWrapper())}}}).call(this);